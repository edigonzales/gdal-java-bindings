name: Build Natives

on:
  workflow_dispatch:
    inputs:
      verify-lock-closure:
        description: "Run resolver drift check (tools/natives/refresh-lock-closure.sh --check)"
        required: false
        type: boolean
        default: false

jobs:
  build-natives:
    strategy:
      fail-fast: false
      matrix:
        include:
          - classifier: linux-x86_64
            os: ubuntu-24.04
          - classifier: linux-aarch64
            os: ubuntu-24.04-arm
          - classifier: osx-x86_64
            os: macos-15-intel
          - classifier: osx-aarch64
            os: macos-15
          - classifier: windows-x86_64
            os: windows-2025
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '23'

      - name: Install conda-package-handling
        shell: bash
        run: |
          python -m pip install --user conda-package-handling
          USER_BASE="$(python -m site --user-base)"
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "$USER_BASE/Scripts" >> "$GITHUB_PATH"
          else
            echo "$USER_BASE/bin" >> "$GITHUB_PATH"
          fi

      - name: Make scripts executable
        shell: bash
        run: chmod +x ./gradlew tools/natives/*.sh

      - name: Validate lock file
        shell: bash
        run: tools/natives/verify-lock.sh

      - name: Validate lock closure
        if: ${{ inputs.verify-lock-closure }}
        shell: bash
        run: tools/natives/refresh-lock-closure.sh --check

      - name: Install patchelf (Linux only)
        if: startsWith(matrix.classifier, 'linux-')
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf

      - name: Stage native payload
        shell: bash
        run: tools/natives/fetch-and-stage.sh ${{ matrix.classifier }}

      - name: Audit runtime dependencies
        shell: bash
        run: tools/natives/audit-runtime-deps.sh ${{ matrix.classifier }}

      - name: Assemble natives jars
        shell: bash
        run: ./gradlew :gdal-ffm-natives:assemble

      - name: Run packaged smoke (standard)
        if: startsWith(matrix.classifier, 'linux-') || startsWith(matrix.classifier, 'osx-')
        shell: bash
        run: |
          set -euo pipefail
          matches=()
          while IFS= read -r path; do
            [[ -n "$path" ]] && matches+=("$path")
          done < <(
            find gdal-ffm-natives/build/libs -maxdepth 1 -type f \
              -name "gdal-ffm-natives-*-natives-${{ matrix.classifier }}.jar" \
              ! -name "gdal-ffm-natives-swiss-*" \
              | sort
          )
          if [[ ${#matches[@]} -ne 1 ]]; then
            echo "Expected exactly one standard native jar for classifier ${{ matrix.classifier }}, found ${#matches[@]}" >&2
            printf '%s\n' "${matches[@]}" >&2 || true
            exit 1
          fi
          jar_path="${matches[0]}"
          ./gradlew :gdal-ffm-core:smokeTestPackagedNative \
            -PgdalFfmSmokeNativeJar="$jar_path" \
            -PgdalFfmSmokeLabel="${{ matrix.classifier }}-standard"

      - name: Run packaged smoke (swiss)
        if: startsWith(matrix.classifier, 'linux-') || startsWith(matrix.classifier, 'osx-')
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          matches=(gdal-ffm-natives/build/libs/gdal-ffm-natives-swiss-*-natives-${{ matrix.classifier }}.jar)
          if [[ ${#matches[@]} -ne 1 ]]; then
            echo "Expected exactly one swiss native jar for classifier ${{ matrix.classifier }}, found ${#matches[@]}" >&2
            printf '%s\n' "${matches[@]}" >&2 || true
            exit 1
          fi
          jar_path="${matches[0]}"
          ./gradlew :gdal-ffm-core:smokeTestPackagedNative \
            -PgdalFfmSmokeNativeJar="$jar_path" \
            -PgdalFfmSmokeLabel="${{ matrix.classifier }}-swiss"

      - name: Upload classifier artifact (standard)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-*-natives-${{ matrix.classifier }}.jar

      - name: Upload classifier artifact (swiss)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-swiss-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-swiss-*-natives-${{ matrix.classifier }}.jar
