name: Build Natives

on:
  workflow_dispatch:

jobs:
  build-natives:
    strategy:
      fail-fast: false
      matrix:
        include:
          - classifier: linux-x86_64
            os: ubuntu-latest
          - classifier: linux-aarch64
            os: ubuntu-latest
          - classifier: osx-x86_64
            os: macos-latest
          - classifier: osx-aarch64
            os: macos-latest
          - classifier: windows-x86_64
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '23'

      - name: Install conda-package-handling
        shell: bash
        run: |
          python -m pip install --user conda-package-handling
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Make scripts executable
        shell: bash
        run: chmod +x ./gradlew tools/natives/*.sh

      - name: Validate lock file
        shell: bash
        run: tools/natives/verify-lock.sh

      - name: Validate lock closure
        shell: bash
        run: tools/natives/refresh-lock-closure.sh --check

      - name: Stage native payload
        shell: bash
        run: tools/natives/fetch-and-stage.sh ${{ matrix.classifier }}

      - name: Audit runtime dependencies
        shell: bash
        run: tools/natives/audit-runtime-deps.sh ${{ matrix.classifier }}

      - name: Assemble natives jars
        shell: bash
        run: ./gradlew :gdal-ffm-natives:assemble

      - name: Upload classifier artifact (standard)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-*-natives-${{ matrix.classifier }}.jar

      - name: Upload classifier artifact (swiss)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-swiss-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-swiss-*-natives-${{ matrix.classifier }}.jar
