name: Release

on:
  workflow_dispatch:

jobs:
  build-natives:
    strategy:
      fail-fast: false
      matrix:
        include:
          - classifier: linux-x86_64
            os: ubuntu-24.04
          - classifier: linux-aarch64
            os: ubuntu-24.04-arm
          - classifier: osx-x86_64
            os: macos-15-intel
          - classifier: osx-aarch64
            os: macos-15
          - classifier: windows-x86_64
            os: windows-2025
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '23'

      - name: Install conda-package-handling
        shell: bash
        run: |
          python -m pip install --user conda-package-handling
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Make scripts executable
        shell: bash
        run: chmod +x ./gradlew tools/natives/*.sh

      - name: Validate lock file
        shell: bash
        run: tools/natives/verify-lock.sh

      - name: Validate lock closure
        shell: bash
        run: tools/natives/refresh-lock-closure.sh --check

      - name: Stage native payload
        shell: bash
        run: tools/natives/fetch-and-stage.sh ${{ matrix.classifier }}

      - name: Audit runtime dependencies
        shell: bash
        run: tools/natives/audit-runtime-deps.sh ${{ matrix.classifier }}

      - name: Assemble natives jars
        shell: bash
        run: ./gradlew :gdal-ffm-natives:assemble

      - name: Run packaged smoke (standard)
        if: startsWith(matrix.classifier, 'linux-') || startsWith(matrix.classifier, 'osx-')
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          matches=(gdal-ffm-natives/build/libs/gdal-ffm-natives-*-natives-${{ matrix.classifier }}.jar)
          if [[ ${#matches[@]} -ne 1 ]]; then
            echo "Expected exactly one standard native jar for classifier ${{ matrix.classifier }}, found ${#matches[@]}" >&2
            printf '%s\n' "${matches[@]}" >&2 || true
            exit 1
          fi
          jar_path="${matches[0]}"
          ./gradlew :gdal-ffm-core:smokeTestPackagedNative \
            -PgdalFfmSmokeNativeJar="$jar_path" \
            -PgdalFfmSmokeLabel="${{ matrix.classifier }}-standard"

      - name: Run packaged smoke (swiss)
        if: startsWith(matrix.classifier, 'linux-') || startsWith(matrix.classifier, 'osx-')
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          matches=(gdal-ffm-natives/build/libs/gdal-ffm-natives-swiss-*-natives-${{ matrix.classifier }}.jar)
          if [[ ${#matches[@]} -ne 1 ]]; then
            echo "Expected exactly one swiss native jar for classifier ${{ matrix.classifier }}, found ${#matches[@]}" >&2
            printf '%s\n' "${matches[@]}" >&2 || true
            exit 1
          fi
          jar_path="${matches[0]}"
          ./gradlew :gdal-ffm-core:smokeTestPackagedNative \
            -PgdalFfmSmokeNativeJar="$jar_path" \
            -PgdalFfmSmokeLabel="${{ matrix.classifier }}-swiss"

      - name: Upload classifier artifact (standard)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-*-natives-${{ matrix.classifier }}.jar

      - name: Upload classifier artifact (swiss)
        uses: actions/upload-artifact@v4
        with:
          name: gdal-ffm-natives-swiss-${{ matrix.classifier }}
          path: gdal-ffm-natives/build/libs/gdal-ffm-natives-swiss-*-natives-${{ matrix.classifier }}.jar

  publish:
    needs: build-natives
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '23'

      - name: Make gradlew executable
        shell: bash
        run: chmod +x ./gradlew

      - name: Download native release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gdal-ffm-natives*
          merge-multiple: true
          path: gdal-ffm-natives/build/libs

      - name: Verify downloaded native jars
        shell: bash
        run: |
          set -euo pipefail
          actual="$(find gdal-ffm-natives/build/libs -maxdepth 1 -type f -name '*.jar' | wc -l | tr -d ' ')"
          if [[ "$actual" -lt 10 ]]; then
            echo "Expected at least 10 native jars (5 standard + 5 swiss), got $actual" >&2
            find gdal-ffm-natives/build/libs -maxdepth 1 -type f -name '*.jar' -print >&2 || true
            exit 1
          fi
          find gdal-ffm-natives/build/libs -maxdepth 1 -type f -name '*.jar' -print | sort

      - name: Publish artifacts
        env:
          MAVEN_REPOSITORY_URL: ${{ secrets.MAVEN_REPOSITORY_URL }}
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        shell: bash
        run: |
          ./gradlew \
            :gdal-ffm-core:check \
            :gdal-ffm-natives:check \
            :gdal-ffm-core:publishMavenJavaPublicationToReleaseTargetRepository \
            :gdal-ffm-natives:publishNativesPublicationToReleaseTargetRepository \
            :gdal-ffm-natives:publishNativesSwissPublicationToReleaseTargetRepository \
            -x :gdal-ffm-natives:nativesJarLinuxX8664 \
            -x :gdal-ffm-natives:nativesJarLinuxAarch64 \
            -x :gdal-ffm-natives:nativesJarOsxX8664 \
            -x :gdal-ffm-natives:nativesJarOsxAarch64 \
            -x :gdal-ffm-natives:nativesJarWindowsX8664 \
            -x :gdal-ffm-natives:nativesSwissJarLinuxX8664 \
            -x :gdal-ffm-natives:nativesSwissJarLinuxAarch64 \
            -x :gdal-ffm-natives:nativesSwissJarOsxX8664 \
            -x :gdal-ffm-natives:nativesSwissJarOsxAarch64 \
            -x :gdal-ffm-natives:nativesSwissJarWindowsX8664
